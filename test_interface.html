<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST INTERFACE IA</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .drop-zone { border: 2px dashed #007bff; padding: 40px; text-align: center; margin: 20px 0; border-radius: 10px; background: #f8f9ff; cursor: pointer; }
        .drop-zone:hover { background: #e6f2ff; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .loading { text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† TEST INTERFACE IA SYSCOHADA CI</h1>
        <p>Testez l'analyse de factures avec l'IA Gemini</p>
        
        <div class="drop-zone" id="dropZone">
            <h3>üìÑ Glissez votre facture ici</h3>
            <p>Ou cliquez pour s√©lectionner</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Choisir un fichier</button>
        </div>

        <div id="preview" style="display: none;">
            <h3>üìã Aper√ßu :</h3>
            <img id="previewImage" style="max-width: 300px; border-radius: 5px;">
        </div>

        <button id="scanBtn" class="btn" style="width: 100%; margin: 20px 0;" disabled>
            üîç Analyser la facture
        </button>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>üß† Analyse en cours...</p>
        </div>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        class TestScanSystem {
            constructor() {
                this.apiEndpoint = '/ia_traitement_standalone.php';
                this.currentFile = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const scanBtn = document.getElementById('scanBtn');

                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.background = '#e6f2ff';
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.background = '#f8f9ff';
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.background = '#f8f9ff';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });

                scanBtn.addEventListener('click', () => this.scanFile());
            }

            handleFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('Veuillez s√©lectionner une image');
                    return;
                }

                this.currentFile = file;
                this.showPreview(file);
                document.getElementById('scanBtn').disabled = false;
            }

            showPreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            async scanFile() {
                if (!this.currentFile) return;

                const loading = document.getElementById('loading');
                const scanBtn = document.getElementById('scanBtn');
                const result = document.getElementById('result');

                loading.style.display = 'block';
                scanBtn.disabled = true;
                result.style.display = 'none';

                const formData = new FormData();
                formData.append('facture', this.currentFile);

                try {
                    const response = await fetch(this.apiEndpoint, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.displayResult(data);

                } catch (error) {
                    console.error('Erreur:', error);
                    result.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
                    result.style.display = 'block';
                } finally {
                    loading.style.display = 'none';
                    scanBtn.disabled = false;
                }
            }

            displayResult(data) {
                const result = document.getElementById('result');
                
                let html = '<div class="success">‚úÖ Analyse r√©ussie !</div>';
                html += '<h3>üìä R√©sultats de l\'analyse :</h3>';
                html += `<p><strong>Type:</strong> ${data.type_document || 'N/A'}</p>`;
                html += `<p><strong>Fournisseur:</strong> ${data.tiers || 'N/A'}</p>`;
                html += `<p><strong>Date:</strong> ${data.date || 'N/A'}</p>`;
                html += `<p><strong>R√©f√©rence:</strong> ${data.reference || 'N/A'}</p>`;
                html += `<p><strong>Montant HT:</strong> ${data.montant_ht || 0} XOF</p>`;
                html += `<p><strong>Montant TVA:</strong> ${data.montant_tva || 0} XOF</p>`;
                html += `<p><strong>Montant TTC:</strong> ${data.montant_ttc || 0} XOF</p>`;

                if (data.ecriture && data.ecriture.length > 0) {
                    html += '<h3>üìã √âcriture comptable SYSCOHADA CI:</h3>';
                    html += '<table border="1" style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><th>Compte</th><th>Libell√©</th><th>D√©bit</th><th>Cr√©dit</th></tr>';
                    
                    let totalDebit = 0;
                    let totalCredit = 0;
                    
                    data.ecriture.forEach(ligne => {
                        html += `<tr>`;
                        html += `<td>${ligne.compte}</td>`;
                        html += `<td>${ligne.intitule}</td>`;
                        html += `<td>${ligne.debit}</td>`;
                        html += `<td>${ligne.credit}</td>`;
                        html += `</tr>`;
                        totalDebit += parseFloat(ligne.debit) || 0;
                        totalCredit += parseFloat(ligne.credit) || 0;
                    });
                    
                    html += `<tr style="font-weight: bold;">`;
                    html += `<td colspan="2">TOTAUX</td>`;
                    html += `<td>${totalDebit}</td>`;
                    html += `<td>${totalCredit}</td>`;
                    html += `</tr>`;
                    html += '</table>';
                    
                    if (Math.abs(totalDebit - totalCredit) < 0.01) {
                        html += '<p class="success">‚úÖ √âcriture √âQUILIBR√âE</p>';
                    } else {
                        html += '<p class="error">‚ö†Ô∏è √âcriture NON √âQUILIBR√âE</p>';
                    }
                }

                result.innerHTML = html;
                result.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TestScanSystem();
        });
    </script>
</body>
</html>
